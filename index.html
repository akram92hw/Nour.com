<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nour ‚Äì Compagnon Spirituel</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Amiri+Quran&display=swap" rel="stylesheet">

<style>
body {
    margin: 0;
    font-family: Poppins, sans-serif;
    background: #0f172a; /* Bleu fonc√©/noir √©l√©gant */
    color: white;
    overflow-x: hidden;
}

header {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #020617;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); /* Ombres r√©alistes */
    position: sticky;
    top: 0;
    z-index: 100;
}

.logo {
    font-size: 1.5rem;
    font-weight: 800;
    transform: perspective(500px) rotateY(10deg); /* Effet 3D */
    transition: transform 0.3s ease; /* Animations fluides */
}

.logo:hover {
    transform: perspective(500px) rotateY(0deg);
}

button {
    padding: 10px 18px;
    border: none;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Profondeur */
    transition: transform 0.2s, box-shadow 0.2s; /* Fluide */
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
}

.btn {
    background: #0ea5e9;
    color: white;
}

.btn-audio {
    background: #22c55e; /* Vert pour audio */
}

.admin-badge {
    background: gold;
    color: black;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 800;
    margin-left: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* 3D */
}

section {
    padding: 40px 20px;
    max-width: 1000px;
    margin: auto;
    background: #1e293b; /* Bleu fonc√© √©l√©gant */
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5); /* Profondeur */
    margin-bottom: 20px;
    transform: perspective(1000px) rotateX(5deg); /* Effet 3D cartes */
    transition: transform 0.3s;
}

section:hover {
    transform: perspective(1000px) rotateX(0deg);
}

input, textarea {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 10px;
    border: none;
    background: #334155;
    color: white;
}

.hidden { display: none; }

.quran {
    font-family: "Amiri Quran", serif;
    font-size: 2rem;
    direction: rtl;
    line-height: 2.5;
    margin: 20px 0;
    background: #020617; /* Immersive */
    padding: 20px;
    border-radius: 10px;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
}

/* Tajweed colors (exemples simplifi√©s) */
.tajweed-madd { color: #ff0000; } /* Rouge pour madd */
.tajweed-ikhfa { color: #00ff00; } /* Vert pour ikhfa */
.tajweed-idgham { color: #0000ff; } /* Bleu pour idgham */

/* Barres de progression */
.progress-bar {
    background: #334155;
    border-radius: 10px;
    height: 20px;
    margin: 10px 0;
    position: relative;
}

.progress-fill {
    background: #0ea5e9;
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease; /* Fluide */
}

/* Navigation premium 8 onglets + nouveaux */
nav {
    display: flex;
    justify-content: space-around;
    background: #020617;
    padding: 10px;
    position: fixed;
    bottom: 0;
    width: 100%;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.5);
}

nav button {
    background: none;
    border: none;
    font-size: 1.2rem;
    transform: perspective(500px) rotateY(10deg); /* Ic√¥nes 3D */
    transition: transform 0.3s;
}

nav button:hover {
    transform: perspective(500px) rotateY(0deg);
}

/* Motifs islamiques subtils (ex: background pattern) */
body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M50 0L100 50L50 100L0 50Z" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="2"/></svg>') repeat;
    opacity: 0.1;
    z-index: -1;
}

/* Responsive */
@media (max-width: 700px) {
    .quran { font-size: 1.5rem; }
    nav { flex-wrap: wrap; }
    section { max-width: 90%; }
}

@media (min-width: 1024px) {
    section { max-width: 1200px; }
}
</style>
</head>

<body>

<header>
    <h2 class="logo">Nour</h2>
    <div id="userArea"></div>
    <input id="globalSearch" placeholder="Recherche globale..." style="width: auto; margin-left: auto;">
</header>

<nav>
    <button onclick="showSection('dashboard')">üè† Dashboard</button>
    <button onclick="showSection('profile')">üë§ Profil</button>
    <button onclick="showSection('progress')">üìä Progression</button>
    <button onclick="showSection('quran')">üìñ Coran</button>
    <button onclick="showSection('social')">üë• Social</button>
    <button onclick="showSection('goals')">üéØ Objectifs</button>
    <button onclick="showSection('chat')">üí¨ Chat Islamique</button>
    <button onclick="showSection('admin')" id="adminNav" class="hidden">üëë Admin</button>
    <button onclick="logout()">üö™ D√©connexion</button>
</nav>

<section id="auth">
    <h2>Connexion / Inscription</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe">
    <button class="btn" onclick="register()">Cr√©er un compte</button>
    <button class="btn" onclick="login()">Connexion</button>
</section>

<section id="dashboard" class="hidden">
    <h2>Tableau de bord <span id="adminBadge"></span></h2>
    <p>Email : <span id="userEmail"></span></p>
    <p>Utilisateurs inscrits : <span id="userCount"></span></p>
</section>

<section id="profile" class="hidden">
    <h2>Profil</h2>
    <img id="profilePic" src="" alt="Photo de profil" style="width:100px; height:100px; border-radius:50%; box-shadow:0 4px 8px rgba(0,0,0,0.3);">
    <input type="file" id="profileUpload" accept="image/*">
    <button class="btn" onclick="uploadProfilePic()">Upload Photo</button>
    <p>Stats en temps r√©el : <span id="profileStats"></span></p>
</section>

<section id="progress" class="hidden">
    <h2>Progression</h2>
    <p>Pri√®res : <div class="progress-bar"><div class="progress-fill" id="progressPrayers" style="width:0%;"></div></div> <span id="percentPrayers">0%</span></p>
    <p>Coran : <div class="progress-bar"><div class="progress-fill" id="progressQuran" style="width:0%;"></div></div> <span id="percentQuran">0%</span></p>
    <p>Dhikr : <div class="progress-bar"><div class="progress-fill" id="progressDhikr" style="width:0%;"></div></div> <span id="percentDhikr">0%</span></p>
    <p>Mensuel : <div class="progress-bar"><div class="progress-fill" id="progressMonthly" style="width:0%;"></div></div> <span id="percentMonthly">0%</span></p>
</section>

<section id="quran" class="hidden">
    <h2>Coran</h2>
    <select id="surahSelect"></select>
    <div id="quranText" class="quran"></div>
    <button class="btn-audio" onclick="playQuran()">‚ñ∂ Lecture vocale (Yasser Al-Dosari)</button>
    <button class="btn" onclick="startRecitationCorrection()">üó£Ô∏è Corriger ma r√©citation</button>
    <p id="correctionResult"></p>
</section>

<section id="social" class="hidden">
    <h2>Social</h2>
    <h3>Amis</h3>
    <input id="friendEmail" placeholder="Ajouter ami par email">
    <button class="btn" onclick="addFriend()">Ajouter</button>
    <ul id="friendsList"></ul>

    <h3>Groupes</h3>
    <input id="groupName" placeholder="Cr√©er groupe">
    <button class="btn" onclick="createGroup()">Cr√©er</button>
    <ul id="groupsList"></ul>

    <h3>Messages</h3>
    <select id="chatWith"></select>
    <textarea id="messageInput" placeholder="Message..."></textarea>
    <button class="btn" onclick="sendMessage()">Envoyer</button>
    <div id="chatHistory"></div>
</section>

<section id="goals" class="hidden">
    <h2>Objectifs</h2>
    <input id="goalName" placeholder="Nom objectif">
    <input id="goalTarget" placeholder="Cible (ex: 100)">
    <input id="goalIcon" placeholder="Ic√¥ne (ex: üìñ)">
    <button class="btn" onclick="createGoal()">Cr√©er</button>
    <ul id="goalsList"></ul>
</section>

<section id="chat" class="hidden">
    <h2>Chat GPT Musulman</h2>
    <p>Entrez votre cl√© OpenAI API (une fois) : <input id="apiKey" placeholder="sk-..."></p>
    <button class="btn" onclick="saveApiKey()">Sauvegarder cl√©</button>
    <textarea id="questionInput" placeholder="Posez une question sur l'Islam..."></textarea>
    <button class="btn" onclick="askMuslimAI()">Demander</button>
    <div id="aiResponse"></div>
</section>

<section id="admin" class="hidden">
    <h2>Panneau Administrateur <span class="admin-badge">ADMINISTRATEUR</span></h2>
    <h3>Contr√¥le total</h3>
    <ul id="allUsers"></ul>
    <button class="btn" onclick="deleteUser(prompt('Email √† supprimer'))">Supprimer utilisateur</button>
</section>

<audio id="audio"></audio>

<script>
const ADMIN_EMAIL = "unjour121@gmail.com";
const QURAN_API_BASE = "https://api.alquran.cloud/v1";

/* UTILITAIRES */
function getUsers(){ return JSON.parse(localStorage.getItem("users")) || [] }
function saveUsers(u){ localStorage.setItem("users", JSON.stringify(u)) }
function getSession(){ return JSON.parse(localStorage.getItem("session")) }
function getUserData(email){ let u = getUsers().find(u => u.email === email); return u ? u.data || {} : {} }
function saveUserData(email, data){ let users = getUsers(); let idx = users.findIndex(u => u.email === email); if(idx !== -1){ users[idx].data = data; saveUsers(users); } }

/* AUTH (inchang√©e) */
function register(){
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!email || !pass) return alert("Champs requis");
    let users = getUsers();
    if(users.find(u => u.email === email)) return alert("Compte existant");
    users.push({email, pass, role: email === ADMIN_EMAIL ? "admin" : "user", data: {profilePic: "", stats: {}, progress: {prayers:0, quran:0, dhikr:0, monthly:0}, friends:[], groups:[], messages:{}, goals:[]}});
    saveUsers(users);
    alert("Compte cr√©√©");
    emailInput.value = "";
    passwordInput.value = "";
}

function login(){
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    let users = getUsers();
    let u = users.find(u => u.email === email && u.pass === pass);
    if(!u) return alert("Identifiants incorrects");
    localStorage.setItem("session", JSON.stringify(u));
    location.reload();
}

function logout(){
    localStorage.removeItem("session");
    location.reload();
}

/* SESSION */
const session = getSession();
if(session){
    const auth = document.getElementById("auth");
    const dashboard = document.getElementById("dashboard");
    const userEmail = document.getElementById("userEmail");
    const userCount = document.getElementById("userCount");
    const adminBadge = document.getElementById("adminBadge");
    const userArea = document.getElementById("userArea");
    const adminNav = document.getElementById("adminNav");

    auth.classList.add("hidden");
    dashboard.classList.remove("hidden");
    userEmail.textContent = session.email;
    userCount.textContent = getUsers().length;
    if(session.role === "admin"){
        adminBadge.innerHTML = "ADMINISTRATEUR";
        adminBadge.className = "admin-badge";
        adminNav.classList.remove("hidden");
        loadAdminPanel();
    }
    userArea.innerHTML = `${session.email}`;
    loadProfile();
    loadProgress();
    loadQuran();
    loadSocial();
    loadGoals();
    showSection('dashboard');
}

/* NAVIGATION */
function showSection(id){
    document.querySelectorAll('section:not(#auth)').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove("hidden");
}

/* PROFIL */
function loadProfile(){
    const data = getUserData(session.email);
    document.getElementById("profilePic").src = data.profilePic || "";
    document.getElementById("profileStats").textContent = JSON.stringify(data.stats || {});
}

function uploadProfilePic(){
    const file = document.getElementById("profileUpload").files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        let data = getUserData(session.email);
        data.profilePic = e.target.result;
        saveUserData(session.email, data);
        loadProfile();
    };
    reader.readAsDataURL(file);
}

/* PROGRESSION (simul√©e) */
function loadProgress(){
    const data = getUserData(session.email).progress || {prayers:50, quran:30, dhikr:70, monthly:40}; // Exemple
    document.getElementById("progressPrayers").style.width = `${data.prayers}%`;
    document.getElementById("percentPrayers").textContent = `${data.prayers}%`;
    document.getElementById("progressQuran").style.width = `${data.quran}%`;
    document.getElementById("percentQuran").textContent = `${data.quran}%`;
    document.getElementById("progressDhikr").style.width = `${data.dhikr}%`;
    document.getElementById("percentDhikr").textContent = `${data.dhikr}%`;
    document.getElementById("progressMonthly").style.width = `${data.monthly}%`;
    document.getElementById("percentMonthly").textContent = `${data.monthly}%`;
}

/* CORAN - Chargement dynamique via API */
async function loadQuran(){
    const select = document.getElementById("surahSelect");
    select.innerHTML = "";
    try {
        const meta = await fetch(`${QURAN_API_BASE}/meta`).then(res => res.json());
        const surahs = meta.data.surahs.references;
        surahs.forEach((s, i) => {
            let opt = document.createElement("option");
            opt.value = s.number;
            opt.textContent = `${s.number}. ${s.englishName} (${s.name})`;
            select.appendChild(opt);
        });
        select.onchange = async () => {
            const surahNum = select.value;
            const response = await fetch(`${QURAN_API_BASE}/surah/${surahNum}`);
            const data = await response.json();
            const text = data.data.ayahs.map(a => a.text).join(' ');
            document.getElementById("quranText").innerHTML = text; // Tajweed non support√© par cette API, texte simple
        };
        select.value = 1; select.onchange();
    } catch (e) {
        alert("Erreur chargement Coran: " + e);
    }
}

function playQuran(){
    const surahNum = document.getElementById("surahSelect").value;
    const padded = ('000' + surahNum).slice(-3);
    const a = document.getElementById("audio");
    a.src = `https://server11.mp3quran.net/yasser/${padded}.mp3`;
    a.play();
}

/* CORRECTION R√âCITATION */
let recognition;
function startRecitationCorrection(){
    if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) return alert("Reconnaissance vocale non support√©e dans ce navigateur.");
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ar-SA';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = event => {
        const recited = event.results[0][0].transcript;
        const expected = document.getElementById("quranText").textContent.trim();
        const similarity = stringSimilarity(recited, expected); // Fonction simple similarit√©
        document.getElementById("correctionResult").textContent = `Votre r√©citation: ${recited}\nSimilarit√©: ${Math.round(similarity * 100)}%\nErreurs potentielles: ${similarity < 0.8 ? 'V√©rifiez la prononciation' : 'Bien!'}`;
    };
    recognition.onerror = () => alert("Erreur reconnaissance vocale");
    recognition.start();
    alert("Commencez √† r√©citer la sourate s√©lectionn√©e.");
}

// Fonction simple similarit√© (Levenshtein approximative)
function stringSimilarity(a, b) {
    a = a.replace(/\s+/g, '');
    b = b.replace(/\s+/g, '');
    if (a.length === 0) return b.length ? 0 : 1;
    if (b.length === 0) return a.length ? 0 : 1;
    let matrix = Array.from({length: b.length + 1}, (_, j) => Array(a.length + 1).fill(0));
    for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
    for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
                matrix[j - 1][i] + 1,
                matrix[j][i - 1] + 1,
                matrix[j - 1][i - 1] + cost
            );
        }
    }
    return 1 - matrix[b.length][a.length] / Math.max(a.length, b.length);
}

/* CHAT GPT MUSULMAN */
function saveApiKey(){
    const key = document.getElementById("apiKey").value.trim();
    if(key) localStorage.setItem("openai_key", key);
    alert("Cl√© sauvegard√©e");
}

async function askMuslimAI(){
    const question = document.getElementById("questionInput").value.trim();
    const key = localStorage.getItem("openai_key");
    if(!key) return alert("Entrez votre cl√© OpenAI d'abord (https://platform.openai.com/account/api-keys)");
    if(!question) return alert("Posez une question");
    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${key}`
            },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [
                    {role: "system", content: "You are a knowledgeable Muslim scholar. Answer questions about Islam accurately, based on Quran and Hadith, in French."},
                    {role: "user", content: question}
                ]
            })
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        document.getElementById("aiResponse").textContent = data.choices[0].message.content;
    } catch (e) {
        alert("Erreur: " + e.message);
    }
}

/* SOCIAL */
function loadSocial(){
    const data = getUserData(session.email);
    const friendsList = document.getElementById("friendsList");
    friendsList.innerHTML = "";
    data.friends.forEach(f => { let li = document.createElement("li"); li.textContent = f; friendsList.appendChild(li); });

    const groupsList = document.getElementById("groupsList");
    groupsList.innerHTML = "";
    data.groups.forEach(g => { let li = document.createElement("li"); li.textContent = g; groupsList.appendChild(li); });

    const chatWith = document.getElementById("chatWith");
    chatWith.innerHTML = "";
    data.friends.forEach(f => { let opt = document.createElement("option"); opt.value = f; opt.textContent = f; chatWith.appendChild(opt); });
    loadChat();
}

function addFriend(){
    const friend = document.getElementById("friendEmail").value.trim();
    if(!friend || !getUsers().find(u => u.email === friend)) return alert("Utilisateur non trouv√©");
    let data = getUserData(session.email);
    if(!data.friends.includes(friend)) data.friends.push(friend);
    saveUserData(session.email, data);
    loadSocial();
}

function createGroup(){
    const group = document.getElementById("groupName").value.trim();
    if(!group) return;
    let data = getUserData(session.email);
    data.groups.push(group);
    saveUserData(session.email, data);
    loadSocial();
}

function sendMessage(){
    const to = document.getElementById("chatWith").value;
    const msg = document.getElementById("messageInput").value.trim();
    if(!to || !msg) return;
    let data = getUserData(session.email);
    if(!data.messages[to]) data.messages[to] = [];
    data.messages[to].push({from: session.email, text: msg});
    saveUserData(session.email, data);
    loadChat();
}

function loadChat(){
    const to = document.getElementById("chatWith").value;
    const history = document.getElementById("chat
